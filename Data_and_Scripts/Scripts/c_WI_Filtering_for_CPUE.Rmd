---
title: "Filtering for CPUEs"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Preamble

## Load Libraries
```{r}
library(arrow)
library(tidyverse)
```

## Link to Data
```{r}
wi_data <- open_dataset(sources = "Data_and_Scripts/Data/output/wi_file_arrow/")

wi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "wi_file_arrow"))
glimpse(wi_data)
```

## Walleye CPUE
This process looks like this: 
1. Choose surveys that are deemed suitable for a state-species specific CPUE
2. Count up how many suitable fish were caught in those surveys

#to refine:
#include na survey purposes?
#minimum effort for Wisconsin
#multipule efforts for a survey just days apart in the same sampling method

#problems:
1. na values for cpue stemming from na nhdids?

#general filter table
```{r}
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  group_by(state) %>% 
  distinct(state, sampling_method, species_1, area_group, water_temp_min, .keep_all = T)

write_csv(filter_table_effort, "filter_table.csv")

filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  group_by(state, survey_type) %>% 
  count() %>% 
  select(-n)
```

#hard coded filtering walleye wisconsin
```{r}
# filter to appropriate surveys: 

wi_filter <- fread("https://docs.google.com/spreadsheets/d/e/2PACX-1vTP_AxKOZ_eiehLxOSDModibTEhC0OgWPfgMiUAxfcALq7JJVPpZCD21GRLPi2YNQ/pub?output=csv", na.strings = "")

wi_filter[species == "walleye" & age.class == "adult"]

#is "pe" an intended metric in this table?
wi_data %>% 
  filter(sampling_method%in%c("boom_shocker"), month(date_1)%in%c(3:5), water_temp%in%c(40:50), !is.na(total_effort_1) ) %>% 
  distinct(survey_type_1_indivfish,  survey_type_1_effort, survey_type_2_effort) %>% 
  collect() 
#it shows up in here multiple times, suggesting it is indeed a thing.


# review what kind of surveys make the filter. This is the suitable surveys table
wi_data %>% 
  filter(sampling_method%in%c("fyke_net", "boom_shocker"), month(date_1)%in% c(3:5), water_temp%in%c(40:50), !is.na(total_effort_1) ) %>% 
  distinct(lake_name_1, survey_type_1_indivfish, lake_id, nhdhr_id, date_1, survey_id, sampling_method, total_effort_ident, total_effort_1, total_effort_1_units) %>% 
  collect() 

#can we bake the species counting right into the call for suitable surveys? #note that there are many NA lengths. Do we assume these were juveniles? Something else?
wi_data %>% 
  filter(sampling_method%in%c("fyke_net", "boom_shocker"), month(date_1)%in% c(3:5), water_temp%in%c(40:50), !is.na(total_effort_1)) %>%
  group_by(lake_name_1, lake_id, nhdhr_id, date_1, survey_id, sampling_method,survey_type_1_indivfish, total_effort_ident, total_effort_1, total_effort_1_units, nothing_caught) %>% 
  summarise(count_walleye_13inplus = sum(species_1 == 'walleye' & (length_1 >= 13|is.na(length_1))) ) %>%
  # summarise(count_walleye = sum(species_1 == 'walleye') ) %>%
  collect()%>% 
  mutate(count_walleye_13inplus = case_when(nothing_caught == TRUE ~ 0, 
                               TRUE ~ count_walleye_13inplus)) %>% 
  mutate(cpue = count_walleye_13inplus/as.numeric(total_effort_1)) %>% 
  {.->>suitable_samples}



```

############filtering by table###############################

#Walleye filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "walleye") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "walleye") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_walleye <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_walleye %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct() %>% 
  group_by(sampling_method) %>% 
  glimpse()

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'walleye'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

write_csv(adult_walleye_cpue, "WI_WAE_cpue_filtered.csv")


adult_walleye_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_walleye_cpue %>% 
  filter(is.na(cpue) & is.na(nhdhr_id)) %>% 
  glimpse()

adult_walleye %>% 
  group_by(nothing_caught) %>% 
  count()

#particular case 
good_surveys %>% 
  filter(lake_id == "322500") %>% 
  filter(year(date_1) == 2014) %>% 
  collect() 

good_surveys %>% 
  filter(lake_id == "299000") %>% 
  filter(year(date_1) == 2014) %>% 
  collect()

good_surveys %>% 
  filter(lake_id == "2112800") %>% 
  filter(year(date_1) == 2005) %>% 
  collect()
```

#black crappie filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "black_crappie") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "black_crappie") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()

#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_black_crappie <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_black_crappie)

#checking final filter
adult_black_crappie %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_black_crappie %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_black_crappie %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_black_crappie %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_black_crappie %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  glimpse()

#creating cpue for adult black crappie
adult_black_crappie_cpue <- adult_black_crappie %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'black_crappie'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_black_crappie_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#194 surveys lost when calculating cpue
#na cpue - stems from na nhdids
good_surveys %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
```

#bluegill filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "bluegill") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "bluegill") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_bluegill <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_bluegill)

#checking final filter
adult_bluegill %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_bluegill %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_bluegill %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_bluegill %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_bluegill %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  glimpse()

#creating cpue for adult walleye 
adult_bluegill_cpue <- adult_bluegill %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'bluegill'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_bluegill_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))


adult_bluegill_cpue %>% 
  group_by(nothing_caught) %>% 
  count()

#any na nhdid
adult_bluegill %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
#na nhdids is the difference between good surveys and those that have cpues
```

#largemouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()

#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_largemouth <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_largemouth)

#checking final filter
adult_largemouth %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_largemouth %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_largemouth %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_largemouth %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_largemouth %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#creating cpue for adult walleye 
adult_largemouth_cpue <- adult_largemouth %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'largemouth_bass'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()


adult_largemouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_largemouth %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
#na nhdids are the difference in surveys with and without cpues
```

#smallmouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "smallmouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "smallmouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_smallmouth <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_smallmouth)

#checking final filter
adult_smallmouth %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_smallmouth %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_smallmouth %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_smallmouth %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_smallmouth %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  glimpse()

#creating cpue for adult walleye 
adult_smallmouth_cpue <- adult_smallmouth %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'smallmouth_bass'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_smallmouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_smallmouth %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
#all na cpue values stem from na nhdid
```

#cisco filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "cisco") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "cisco") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_cisco <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_cisco)

#checking final filter
adult_cisco %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_cisco %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_cisco %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_cisco %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_cisco %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    nothing_caught) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#creating cpue for adult cisco 
adult_cisco_cpue <- adult_cisco %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'cisco'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_cisco_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_cisco %>% 
  filter(is.na(water_temp)) %>% 
  glimpse()
#na water temp responsible for the difference in surveys with cpue and non-cpue
```

#northern pike filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "northern_pike") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "northern_pike") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_northern_pike <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_northern_pike)

#checking final filter
adult_northern_pike %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_northern_pike %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_northern_pike %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_northern_pike %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_northern_pike %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  group_by(sampling_method) %>% 
  glimpse()

#creating cpue for adult northern pike 
adult_northern_pike_cpue <- adult_northern_pike %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'northern_pike'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_northern_pike_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_northern_pike %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
#all surveys with na cpues have na nhdids
```

#yellow perch filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "yellow_perch") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -effort_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "yellow_perch") %>% 
  rename(survey_type_1_indivfish = survey_type) %>% 
  select(state,
         -species_1) %>% 
  distinct() 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  left_join(filter_table_effort, by = c("state", 
                                        "survey_type_1_indivfish", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         water_temp >= water_temp_min,
         water_temp <= water_temp_max) %>% 
  #do not include surveys without effort
  filter(total_effort_1 != 0) %>% 
  collect() 

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range
good_surveys %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()


#second step of filtering 
##first - filter entire Wisconsin for records of fish that were included in a "good" survey for adult abundance 
##second - apply fish level filters (species, fish lengths, etc.)
adult_yellow_perch <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  filter(!is.na(nothing_caught)) %>% 
  collect() 
glimpse(adult_yellow_perch)

#checking final filter
adult_yellow_perch %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_yellow_perch %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_yellow_perch %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

#water temp range by sampling method
adult_yellow_perch %>% 
  group_by(sampling_method) %>%
  summarise(min.temp = min(water_temp), max.temp = max(water_temp))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_yellow_perch %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  glimpse()

#creating cpue for adult walleye 
adult_yellow_perch_cpue <- adult_yellow_perch %>% 
  group_by(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    nothing_caught) %>% 
  summarise(count = sum(species_1 == 'yellow_perch'), unique(date_1)) %>%
  mutate(cpue = count/as.numeric(total_effort_1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()

adult_yellow_perch_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#na cpue?
adult_yellow_perch %>% 
  filter(is.na(nhdhr_id)) %>% 
  glimpse()
#all surveys with na cpues have na nhdids
```

#combining species
```{r}
wi_filtered_species <- bind_rows(adult_walleye_cpue %>% 
                                   mutate(species_1 = "walleye"), 
                                 adult_bluegill_cpue %>% 
                                   mutate(species_1 = "bluegill"), 
                                 adult_largemouth_cpue %>% 
                                   mutate(species_1 = "largemouth_bass"), 
                                 adult_smallmouth_cpue %>% 
                                   mutate(species_1 = "smallmouth_bass"), 
                                 adult_cisco_cpue %>% 
                                   mutate(species_1 = "cisco"), 
                                 adult_northern_pike_cpue %>% 
                                   mutate(species_1 = "northern_pike"), 
                                 adult_yellow_perch_cpue %>% 
                                   mutate(species_1 = "yellow_perch"))

write_csv(wi_filtered_species, "wi_filtered_species_cpue")
```


---
title: "Filtering for CPUEs"
author: "Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

2/5:
-big difference in the number of bluegill surverys from good surveys to cpe calcuations was due to the filter that takes only surveys with 1 distinct value in the targeted species columns. Running the adult bluegill with and with out the filter proves the difference. The water temps make up the remaining difference between what is shown in good surveys and cpe

# Libraries 
```{r}
library(arrow)
library(tidyverse)
```

# Data
```{r}
wi_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "wi_file_arrow"))
glimpse(wi_data)
```

#General steps for filtering
-all steps below happen with specific parameters for each species 
1. load in filtering table 
2. filter for good surveys based on species specific conditions
     -in WI its important to ensure that the species are targeted within the survey
     -a binary (Y/N) columns is created to keep track if a species is targeted based
     -a filter table join makes sure the correct sampling methods are used and imports numeric filtering values
     -data is collapsed into survey-level information
     -values are used to filter for month, water_temp, minimum effort, and if the species are targeted in the survey
3. gather all fish records from the good surveys
4. calculate cpe for surveys
    -use survey grouping variable and sum all of the species of interest in a given survey 
       (additional fish level constraints can be used here (ex. length bins))
    -ensure surveys that caught nothing are counted as 0 cpe
    -collapse data into survey level and ensure you retain columns of interest
5. Run checks on all previous steps
     

#Walleye filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "walleye") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("walleye", 
                                                                     "all_species", 
                                                                     "gamefish_species", 
                                                                     "escocid_percid") ~ "Y",
                                        secondary_target_species %in% c("walleye", 
                                                                        "all_species", 
                                                                        "gamefish_species", 
                                                                        "escocid_percid") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect() 

good_surveys %>% 
  distinct(total_effort_ident) 

good_surveys %>% 
  distinct(total_effort_ident) 

#second step of filtering 
##gathering good records associated with "good surveys" 
adult_walleye <- wi_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_walleye_cpue <- adult_walleye %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'walleye')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T) 

#survey level filtering checks
#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)))


#checks after collecting fish back
#what is the survey good for?
adult_walleye %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)),
            min.temp = min(water_temp, na.rm = T), 
            max.temp = max(water_temp, na.rm = T))

adult_walleye %>% 
  group_by(target_species_effort, secondary_target_species, targeted_in_survey) %>% 
  count() %>% 
  print(n = nrow(.))



#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey)

adult_walleye %>% 
  distinct(date,
    total_effort_ident) %>% 
  glimpse()

adult_walleye %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


#checks after calculating cpe
adult_walleye_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_walleye_cpue %>% 
  filter(is.na(cpue))

#removing large fish file to save memory
rm(adult_walleye)
```

#black crappie filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "black_crappie") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("panfish", 
                                                                     "all_species", 
                                                                     "gamefish_species", 
                                                                     "panfish_gamefish", 
                                                                     "black_crappie",
                                                                     "centrarchids",
                                                                     "centrarchid_panfish") ~ "Y",
                                        secondary_target_species %in% c("panfish", 
                                                                        "all_species",
                                                                        "gamefish_species", 
                                                                        "panfish_gamefish", 
                                                                        "black_crappie", 
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish") ~ "Y",
                                        TRUE ~ "N")) %>%  
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect() 

good_surveys %>% 
  distinct(total_effort_ident) %>% 
  count()
#1492

#gather fish records from good surveys
adult_black_crappie <- wi_data %>%
  right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_black_crappie_cpue <- adult_black_crappie %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  mutate(species = case_when(is.na(species) ~ "taxon_na",
                             TRUE ~ species)) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'black_crappie')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T)


#checking survey level filtering
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)))


#checks after collecting fish back
#what is the survey good for?
adult_black_crappie %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()

#is each sampling method correct for the filter?
adult_black_crappie %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)),
            min.temp = min(water_temp, na.rm = T), 
            max.temp = max(water_temp, na.rm = T))

adult_black_crappie %>% 
  group_by(target_species_effort, secondary_target_species, targeted_in_survey) %>% 
  count() %>% 
  print(n = nrow(.))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_black_crappie %>% 
  distinct(
    total_effort_ident) %>% 
  glimpse()

adult_black_crappie %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


#checks after calculating cpe
adult_black_crappie_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_black_crappie_cpue %>% 
  filter(is.na(cpue))

#removing large fish file to save memory
rm(adult_black_crappie)
```

#bluegill filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "bluegill") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type) 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("panfish", 
                                                                     "all_species", 
                                                                     "gamefish_species", 
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish") ~ "Y",
                                        secondary_target_species %in% c("panfish", 
                                                                        "all_species", 
                                                                        "gamefish_species", 
                                                                        "panfish_gamefish", 
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

#gathering fish from good surveys
adult_bluegill <- wi_data %>% 
  right_join(good_surveys) %>%
  collect() %>% 
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_bluegill_cpue <- adult_bluegill %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  mutate(species = case_when(is.na(species) ~ "taxon_na",
                             TRUE ~ species)) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'bluegill')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T)


#filtering checks

good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)))


#checks after collecting fish back
#what is the survey good for?
adult_bluegill %>% 
  group_by(survey_type_1_indivfish) %>% 
  count()

#is each sampling method correct for the filter?
adult_bluegill %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1),
            min.month = min(month(date)), 
            max.month = max(month(date)),
            min.temp = min(water_temp, na.rm = T), 
            max.temp = max(water_temp, na.rm = T))

adult_bluegill %>% 
  distinct(total_effort_ident, target_species_effort, targeted_in_survey, secondary_target_species) %>% 
  group_by(target_species_effort, secondary_target_species, targeted_in_survey) %>% 
  count() %>% 
  print(n = nrow(.))

adult_bluegill %>% 
  filter(is.na(target_species_effort)) %>% 
  glimpse()

#do I retain all of the good surveys? - rows here should match good surveys 
good_surveys %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

adult_bluegill %>% 
  distinct(
    total_effort_ident,
    water_temp) %>% 
  glimpse()

adult_bluegill %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


#checks after calculating cpe
adult_bluegill_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_bluegill_cpue %>% 
  filter(is.na(cpue))

rm(adult_bluegill)
```

#largemouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort.standard <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type) %>% 
  filter(water_temp_min != 0)

filter_table_effort.extra <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>%
  select(-area_group,
         -metric,
         -species_1,
         -survey_type) %>% 
  filter(water_temp_min == 0)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys_standard <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "largemouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "largemouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.standard, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

good_surveys_extra <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "largemouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "largemouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.extra, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

good_surveys <- bind_rows(good_surveys_extra, good_surveys_standard)

 #gathering fish data from good surveys
adult_largemouth <- wi_data %>% 
   right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_largemouth_cpue <- adult_largemouth %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'largemouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T)


#checking survey level filtering
#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1))

#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

good_surveys %>% 
  group_by(month(date), sampling_method) %>% 
  count()

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

good_surveys %>% 
  group_by(targeted_in_survey) %>% 
  count()

 
#checking filtering after collecting fish
adult_largemouth %>% 
  group_by(species) %>% 
  count()

#is the state label the same for all fish
adult_largemouth %>% 
  group_by(state) %>% 
  count()

adult_largemouth %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  print(n = nrow(.))

#water temp range by sampling method
adult_largemouth %>% 
  group_by(month(date), sampling_method) %>%
  summarise(min.temp = min(water_temp, na.rm = T), max.temp = max(water_temp, na.rm = T), min.effort = min(total_effort_1), max = max(total_effort_1))

#do I retain all of the good surveys? - rows here should match good surveys 
good_surveys %>% 
  distinct(total_effort_ident)

adult_largemouth %>% 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  group_by(sampling_method) %>% 
  glimpse()


adult_largemouth %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#checks after calculating cpe
adult_largemouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_largemouth_cpue %>% 
  filter(is.na(cpue))

adult_largemouth %>% 
  group_by(species, total_effort_nothing_caught) %>% 
  count()

#removing large object to save memory
rm(adult_largemouth)
```

#smallmouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort.standard <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "smallmouth_bass") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type) %>% 
  filter(water_temp_min != 0)

filter_table_effort.extra <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "smallmouth_bass") %>%
  select(-area_group,
         -metric,
         -species_1,
         -survey_type) %>% 
  filter(water_temp_min == 0)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys_standard <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "smallmouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "smallmouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.standard, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

good_surveys_extra <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "smallmouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "smallmouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.extra, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

good_surveys <- bind_rows(good_surveys_extra, good_surveys_standard)

#gathering fish data from good surveys
adult_smallmouth <- wi_data %>% 
   right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_smallmouth_cpue <- adult_smallmouth %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'smallmouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T)


#checking survey level filtering
#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1))

#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

good_surveys %>% 
  group_by(month(date), sampling_method) %>% 
  count()

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

good_surveys %>% 
  group_by(targeted_in_survey) %>% 
  count()

 
#checking filtering after collecting fish
adult_smallmouth %>% 
  group_by(species) %>% 
  count()

#is the state label the same for all fish
adult_smallmouth %>% 
  group_by(state) %>% 
  count()

adult_smallmouth %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  print(n = nrow(.))

#water temp range by sampling method
adult_smallmouth %>% 
  group_by(month(date), sampling_method) %>%
  summarise(min.temp = min(water_temp, na.rm = T), max.temp = max(water_temp, na.rm = T), min.effort = min(total_effort_1), max = max(total_effort_1))

#do I retain all of the good surveys? - rows here should match good surveys 
good_surveys %>% 
  distinct(total_effort_ident)

adult_smallmouth %>% 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  group_by(sampling_method) %>% 
  glimpse()


adult_smallmouth %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#checks after calculating cpe
adult_smallmouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_smallmouth_cpue %>% 
  filter(is.na(cpue))

adult_smallmouth %>% 
  group_by(species, total_effort_nothing_caught) %>% 
  count()

#removing large object to save memory
rm(adult_smallmouth)
```

#cisco filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "cisco") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type)


#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "ciscoes_&_whitefishes",
                                                                     "cisco/lake_herring") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "cisco/lake_herring") ~ "Y",
                                        (is.na(target_species_effort) & is.na(secondary_target_species)) ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    #water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         #is.na(water_temp) | water_temp >= water_temp_min,
         #is.na(water_temp) | water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()
#ignoring water temp for these surveys due to data structure and limited samples(note limited samples are not due to temperature restriction, it just makes the filtering easier)

#gathering fish from good surveys
adult_cisco <- wi_data %>% 
  right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1)

#creating cpue for species of interest
adult_cisco_cpue <- adult_cisco %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  mutate(species = case_when(is.na(species) ~ "null",
                             TRUE ~ species)) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(str_detect(species, "cisco"))) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T) 


#checks at the survey level filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#is the state label the same for all fish
adult_cisco %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_cisco %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_cisco %>% 
  distinct(date,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max) %>% 
  group_by(sampling_method) %>% 
  glimpse()

adult_cisco %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#checks after calculating cpe
adult_cisco_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_cisco_cpue %>% 
  filter(is.na(cpue))

#removing large fish object to save memory
rm(adult_cisco)
```

#northern pike filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "northern_pike") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("northern_pike", 
                                                                     "all_species", 
                                                                     "gamefish_species", 
                                                                     "northern_pike_x_muskellunge", 
                                                                     "escocid_percid") ~ "Y",
                                        secondary_target_species %in% c("northern_pike", 
                                                                        "all_species", 
                                                                        "gamefish_species", 
                                                                        "northern_pike_x_muskellunge", 
                                                                        "escocid_percid") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

#collecting fish from good surveys
adult_northern_pike <- wi_data %>% 
  right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1) 

#creating cpue for species of interest
adult_northern_pike_cpue <- adult_northern_pike %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  mutate(species = case_when(is.na(species) ~ "null",
                             TRUE ~ species)) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'northern_pike')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/total_effort_1) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T) 


#checking filtering
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1))

#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

good_surveys %>% 
  group_by(month(date), sampling_method) %>% 
  count()

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

good_surveys %>% 
  group_by(targeted_in_survey) %>% 
  count()

 
#checking filtering after collecting fish
adult_northern_pike %>% 
  group_by(species) %>% 
  count()

#is the state label the same for all fish
adult_northern_pike %>% 
  group_by(state) %>% 
  count()

adult_northern_pike %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  print(n = nrow(.))

#water temp range by sampling method
adult_northern_pike %>% 
  group_by(month(date), sampling_method) %>%
  summarise(min.temp = min(water_temp, na.rm = T), max.temp = max(water_temp, na.rm = T), min.effort = min(total_effort_1), max = max(total_effort_1))

#do I retain all of the good surveys? - rows here should match good surveys 
good_surveys %>% 
  distinct(total_effort_ident)

adult_northern_pike %>% 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  group_by(sampling_method) %>% 
  glimpse()


adult_northern_pike %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#checks after calculating cpe
adult_northern_pike_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_northern_pike_cpue %>% 
  filter(is.na(cpue))

adult_northern_pike %>% 
  group_by(species, total_effort_nothing_caught) %>% 
  count()

#removing large object to save memory
rm(adult_northern_pike)
```

#yellow perch filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "yellow_perch") %>% 
  select(-area_group,
         -metric,
         -species_1,
         -survey_type)

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("yellow_perch", 
                                                                     "all_species",
                                                                     "gamefish_species",
                                                                     "escocid_percid") ~ "Y",
                                        secondary_target_species %in% c("yellow_perch", 
                                                                        "all_species", 
                                                                        "gamefish_species", 
                                                                        "escocid_percid") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table dta to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort, by = c("state", 
                                        "sampling_method")) %>%
  #collapse data into unique surveys 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date) >= month_min,
         month(date) <= month_max,
         !is.na(water_temp) & water_temp >= water_temp_min,
         !is.na(water_temp) & water_temp <= water_temp_max,
         total_effort_1 >= effort_min,
         total_effort_1 <= effort_max,
         targeted_in_survey == "Y") %>% 
  #select(-water_temp) %>% 
  collect()

#collecting fish from good surveys
adult_yellow_perch <- wi_data %>% 
  right_join(good_surveys) %>%
  collect() %>%
  group_by(total_effort_ident) %>% 
  filter(n_distinct(target_species_indivfish) == 1 & n_distinct(secondary_target_species) == 1) 

#creating cpue for species of interest
adult_yellow_perch_cpue <- adult_yellow_perch %>% 
  #grouping by variables to get survey fish count 
  group_by(total_effort_ident) %>% 
  mutate(species = case_when(is.na(species) ~ "taxon_tax",
                             TRUE ~ species)) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species == 'yellow_perch')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(total_effort_nothing_caught == "TRUE" ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1)) %>%
  #collapse data into survey level cpue
  distinct(total_effort_ident, .keep_all = T) 



#checking filtering
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1),
            max.effort = max(total_effort_1))

#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date)), max.month = max(month(date)))

good_surveys %>% 
  group_by(month(date), sampling_method) %>% 
  count()

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

good_surveys %>% 
  group_by(targeted_in_survey) %>% 
  count()

 
#checking filtering after collecting fish
adult_yellow_perch %>% 
  group_by(species) %>% 
  count()

#is the state label the same for all fish
adult_yellow_perch %>% 
  group_by(state) %>% 
  count()

adult_yellow_perch %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  print(n = nrow(.))

#water temp range by sampling method
adult_yellow_perch %>% 
  group_by(month(date), sampling_method) %>%
  summarise(min.temp = min(water_temp, na.rm = T), max.temp = max(water_temp, na.rm = T), min.effort = min(total_effort_1), max = max(total_effort_1))

#do I retain all of the good surveys? - rows here should match good surveys 
good_surveys %>% 
  distinct(total_effort_ident)

adult_yellow_perch %>% 
  distinct(date,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    water_temp,
    month_min, 
    month_max,
    water_temp_min,
    water_temp_max,
    effort_min,
    effort_max,
    targeted_in_survey) %>% 
  group_by(sampling_method) %>% 
  glimpse()


adult_yellow_perch %>% 
  distinct(total_effort_ident) %>% 
  glimpse()

#checks after calculating cpe
adult_yellow_perch_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_yellow_perch_cpue %>% 
  filter(is.na(cpue))

adult_yellow_perch %>% 
  group_by(species, total_effort_nothing_caught) %>% 
  count()

#removing large fish object
rm(adult_yellow_perch)
```

#combining species
```{r}
wi_filtered_species <- bind_rows(adult_walleye_cpue %>% 
                                   mutate(species_1 = "walleye"), 
                                 adult_bluegill_cpue %>% 
                                   mutate(species_1 = "bluegill"), 
                                 adult_black_crappie_cpue %>% 
                                   mutate(species_1 = "black_crappie"),
                                 adult_largemouth_cpue %>% 
                                   mutate(species_1 = "largemouth_bass"), 
                                 adult_smallmouth_cpue %>% 
                                   mutate(species_1 = "smallmouth_bass"), 
                                 adult_cisco_cpue %>% 
                                   mutate(species_1 = "cisco"), 
                                 adult_northern_pike_cpue %>% 
                                   mutate(species_1 = "northern_pike"), 
                                 adult_yellow_perch_cpue %>% 
                                   mutate(species_1 = "yellow_perch"))

write_csv(wi_filtered_species, "WI_all_cpue_filtered.csv")
```


#general data exploration
```{r}
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  group_by(state) %>% 
  distinct(state, sampling_method, species_1, area_group, water_temp_min, .keep_all = T)

filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  group_by(state, survey_type) %>% 
  count() %>% 
  select(-n)

#fall efishing and spring netting for bass 
wi_data %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))
#never conflict but effort gives more info

wi_data %>% 
  group_by(target_species_effort) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))


wi_data %>% 
  group_by(secondary_target_species) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  group_by(survey_type_1_effort) %>% 
  count() %>% 
  collect()

#what species are in some targeted surveys/survey purposes?
target_species <- wi_data %>% 
  group_by(target_species_effort, secondary_target_species, species_1) %>% 
  count() %>% 
  collect() 

survey_purpose <- wi_data %>% 
  group_by(survey_type_1_indivfish, species_1) %>% 
  count() %>% 
  collect()

#effort in wi?
wi_data %>% 
  group_by(sampling_method, total_effort_1_units) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  group_by(sampling_method, total_effort_2_units) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

wi_data %>% 
  filter(sampling_method == "fyke_net") %>% 
  group_by(total_effort_1_units, total_effort_2_units) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))

#########attempted fix for net nights#####
wi_data %>% 
  mutate(total_effort_1 = case_when(sampling_method == "fyke_net" ~ as.numberic(total_effort_1/24) ~
                                    TRUE ~ total_effort_1)) %>% 
  mutate(total_effort_1_units= case_when(sampling_method == "fyke_net" ~ "nights" ~
                                    TRUE ~ total_effort_1_units)) %>%
  mutate(total_effort = case_when(sampling_method == "fyke_net" ~ total_effort_1*total_effort_2,
                                  TRUE ~ total_effort_1)) %>% 
  mutate(total_effort_units = case_when(sampling_method == "fyke_net" ~ "net_nights",
                                        TRUE ~ total_effort_1_units)) %>% 
  group_by(total_effort, total_effort_units) %>% 
  summarise(min = min(total_effort_2, na.rm = T), max = max(total_effort_2, na.rm = T), mean = mean(total_effort_2, na.rm = T)) %>% 
  collect() %>% 
  print(n = nrow(.))

odd_survey <- wi_data %>% 
  filter(nhdhr_id == "nhdhr_77358700" & date_1 == "2000-04-04") %>% 
  collect() %>% 
  distinct(total_effort_ident, total_effort_1)
  
######how are cisco being caught?
wi_data %>% 
  filter(str_detect(species, "cisco")) %>% 
  distinct(total_effort_ident, sampling_method, date) %>% 
  group_by(sampling_method) %>% 
  count() %>% 
  collect()

wi_data %>% 
  filter(sampling_method == "vertical_gill_net") %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  collect()

cisco <- wi_data %>% 
  filter(is.na(target_species_effort) & is.na(secondary_target_species)) %>% 
  filter(sampling_method == "vertical_gill_net") %>% 
  collect() %>% 
  distinct(total_effort_ident, .keep_all = T) 
```

#largemouth filtering - old
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort.standard <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type,
         survey_type_1_effort = survey_type_effort) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -target_species_1,
         -target_species_2,
         -survey_type_1_effort,
         -survey_type_1_indivfish,
         -length_min,
         -length_max) %>% 
  filter(!is.na(water_temp_min))

filter_table_effort.extra <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Wisconsin" & species_1 == "largemouth_bass") %>% 
  rename(survey_type_1_indivfish = survey_type,
         survey_type_1_effort = survey_type_effort) %>% 
  filter(is.na(water_temp_min)) %>% 
  select(-area_group,
         -metric,
         -species_1,
         -target_species_1,
         -target_species_2,
         -survey_type_1_effort,
         -survey_type_1_indivfish,
         -length_min,
         -length_max,
         -water_temp_min,
         -water_temp_max) 

#filters entire Wisconsin data for surveys representative of adult abundance 
good_surveys_standard <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "largemouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "largemouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.standard, by = c("state", 
                                        "sampling_method")) %>% 
  #collapse data into unique surveys 
    distinct(lake_name_1,
             date_1,
             lake_id,
             survey_id,
             sampling_method,
             total_effort_ident,
             total_effort_1,
             total_effort_1_units,
             nothing_caught,
             targeted_in_survey,
             month_min,
             month_max,
             water_temp_min,
             water_temp_max,
             effort_min,
             water_temp
             ) %>% 
mutate(total_effort_1 = as.numeric(total_effort_1)) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         (is.na(water_temp_min) | water_temp >= water_temp_min),
         (is.na(water_temp_max) | water_temp <= water_temp_max),
         total_effort_1 >= effort_min,
         total_effort_1 >= effort_min,
         targeted_in_survey == "Y") %>% 
  select(-water_temp,
         -water_temp_min,
         -water_temp_max) %>% 
  collect()

good_surveys_extra <- wi_data %>%
  mutate(targeted_in_survey = case_when(target_species_effort %in% c("all_species", 
                                                                     "basses",
                                                                     "gamefish_species",
                                                                     "panfish_gamefish", 
                                                                     "centrarchids", 
                                                                     "centrarchid_panfish",
                                                                     "largemouth_bass") ~ "Y",
                                        secondary_target_species %in% c("all_species",
                                                                        "basses", 
                                                                        "gamefish_species",
                                                                        "panfish_gamefish",
                                                                        "centrarchids", 
                                                                        "centrarchid_panfish", 
                                                                        "largemouth_bass") ~ "Y",
                                        TRUE ~ "N")) %>%
  #first join the filter table data to the Wisconsin data (while also filtering for survey purpose)
  right_join(filter_table_effort.extra, by = c("state", 
                                        "sampling_method")) %>% 
  #collapse data into unique surveys 
    distinct(lake_name_1,
             date_1,
             lake_id,
             survey_id,
             sampling_method,
             total_effort_ident,
             total_effort_1,
             total_effort_1_units,
             nothing_caught,
             targeted_in_survey,
             month_min,
             month_max,
             effort_min
             ) %>% 
mutate(total_effort_1 = as.numeric(total_effort_1)) %>% 
  #filter surveys that meet criteria for a species 
  filter(month(date_1) >= month_min,
         month(date_1) <= month_max,
         total_effort_1 >= effort_min,
         total_effort_1 >= effort_min,
         targeted_in_survey == "Y") %>% 
  collect()

good_surveys <- bind_rows(good_surveys_extra, good_surveys_standard)

 #gathering fish data from good surveys
adult_largemouth <- wi_data %>% 
   mutate(total_effort_1 = as.numeric(total_effort_1)) %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  mutate(state = "Wisconsin") %>%
  collect()

#creating cpue for species of interest
adult_largemouth_cpue <- adult_largemouth %>% 
  #grouping by variables to get survey fish count 
  group_by(lake_name_1,
    lake_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1) %>% 
  #counts fish of a particular species in a survey 
  mutate(count = sum(species_1 == 'largemouth_bass')) %>% 
  #surveys that did not catch fish (species column is na) return a catch of 0
  mutate(count = case_when(is.na(species_1) ~ 0,
                           TRUE ~ count)) %>% 
  #generates cpue from counts and efforts associated with that survey count
  mutate(cpue = count/as.numeric(total_effort_1)) %>%
  #collapse data into survey level cpue
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    date_1,
    nhdhr_id,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    nothing_caught,
    count,
    cpue) %>% 
  collect()


#checking survey level filtering
#min effort
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.effort = min(total_effort_1))

#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_1)), max.month = max(month(date_1)))

good_surveys %>% 
  group_by(month(date_1), sampling_method) %>% 
  count()

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

good_surveys %>% 
  group_by(targeted_in_survey) %>% 
  count()

 
#checking filtering after collecting fish
adult_largemouth %>% 
  group_by(species_1) %>% 
  count()

#is the state label the same for all fish
adult_largemouth %>% 
  group_by(state) %>% 
  count()

adult_largemouth %>% 
  group_by(target_species_effort, secondary_target_species) %>% 
  count() %>% 
  print(n = nrow(.))

#water temp range by sampling method
adult_largemouth %>% 
  group_by(month(date_1), sampling_method) %>%
  summarise(min.temp = min(water_temp, na.rm = T), max.temp = max(water_temp, na.rm = T))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_largemouth %>% 
  distinct(lake_name_1,
    survey_type_1_indivfish,
    lake_id,
    nhdhr_id,
    date_1,
    survey_id,
    sampling_method,
    total_effort_ident,
    total_effort_1,
    total_effort_1_units,
    water_temp,
    month_min, 
    month_max,
    nothing_caught) %>% 
  group_by(sampling_method) %>% 
  glimpse()


adult_largemouth %>% 
  distinct(total_effort_ident) %>% 
  glimpse()


#checks after calculating cpe
adult_largemouth_cpue %>% 
  group_by(sampling_method) %>% 
  summarise(min = min(cpue), max = max(cpue))

#any na cpue?
adult_largemouth_cpue %>% 
  filter(is.na(cpue))

adult_largemouth %>% 
  group_by(species_1, nothing_caught) %>% 
  count()

#removing large object to save memory
rm(adult_largemouth)
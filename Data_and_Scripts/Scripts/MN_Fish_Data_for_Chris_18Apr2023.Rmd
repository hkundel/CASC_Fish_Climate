---
title: "MN_Fish_Data_for_Chris_18Apr2023"
author: "Holly Kundel"
date: '`r Sys.Date()`'
output: html_document
---

Load in required packages
```{r}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
```



Read in raw MN Data
```{r, warning=FALSE}
# Load in gillnet and trapnet data

GN_TN <- read_csv("E:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/MN_Data/mn_raw_disaggregated_data/mn_fish_effort_03May2022.csv")

#Load in shallow and deep gillnets, same kind of net, different gear code

GDE_GSH <- read_csv("E:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/MN_Data/mn_raw_disaggregated_data/mn_gde_gsh_fish_effort_03May2022.csv")
```

Combine GN, TN, GDE, GSH into one df
```{r}
all_GN_TN <- bind_rows(GN_TN, GDE_GSH)
```


Determine Number of unique surveys/gears and number of total species
```{r}
Effort_GN_TN <-  all_GN_TN %>%
  select( SURVEY_ID, SURVEYDATE, SURVEYTYPE, DOW, LKNAME, YEAR, GEAR, EFFORT)%>%
  group_by( SURVEY_ID, SURVEYDATE, SURVEYTYPE, DOW, LKNAME, YEAR, GEAR, EFFORT)%>%
  summarise(NUMBER_OF_SP = n())%>%
  select(-NUMBER_OF_SP)%>%
  filter(SURVEYTYPE %in% c("Population Assessment",
                           "Re-Survey",
                           "Standard Survey",
                           "Special Assessment",
                           "Targeted Survey",
                           "Large Lake Survey",
                           "Research Survey",
                           "Initial Survey"))%>% #only keep representative survey types
  mutate(SURVEY_ID_GEAR = str_c(SURVEY_ID, GEAR, sep = "_"))

#21,207 unique survey/gears (i.e. a survey may be listed more than once if more than one gear was used, each row is a unique survey and gear)

Num_species <- all_GN_TN %>%
  group_by(COMMON_NAME)%>%
  summarise(Total_Instances = n()) #129 total species, note not all of them are fish

Cisco_name_check <- Num_species%>%
  filter(str_detect(Num_species$COMMON_NAME, "cisco"))
```


Add instances of zero catch

* quick note about lake IDs (DOW), there are some streams/rivers listed and they have letters in the DOW ID and vary in length
  * creating a new column `WATERBODY_TYPE` to address this in case it matters for analysis
```{r}
MN_Catch_0 <- all_GN_TN %>%
  filter(SURVEYTYPE %in% c("Population Assessment",
                           "Re-Survey",
                           "Standard Survey",
                           "Special Assessment",
                           "Targeted Survey",
                           "Large Lake Survey",
                           "Research Survey",
                           "Initial Survey"))%>% #only keep representative survey types
  mutate(WATERBODY_TYPE = if_else(str_detect(DOW, "[:alpha:]"), paste("river/stream"), paste("lake")))%>%
  select(-CPUE)%>% #better to calculate CPUE ourselves
  pivot_wider(id_cols = c(SURVEY_ID, SURVEYDATE, SURVEYTYPE, DOW, LKNAME, YEAR, GEAR, EFFORT, WATERBODY_TYPE),
              names_from = COMMON_NAME, values_from = TOTAL_CATCH, values_fill = 0) %>% #creates 0s, 21,207 surveys/gears matches check above
  select("SURVEY_ID",    #select columns to keep and
         "SURVEYDATE",
         "SURVEYTYPE",
         "DOW",
         "LKNAME",
         "YEAR",
         "GEAR",
         "EFFORT",
         "WATERBODY_TYPE",
         "black crappie",    #select species of interest
         "bluegill",
         "largemouth bass",
         "northern pike",
         "smallmouth bass",
         "walleye",
         "yellow perch",                 
         "tullibee (cisco)", #2364 instances    # note that cisco species are listed three ways in the data
         "cisco species",  # 163 instances
         "shortjaw cisco", # 1 instance
         "white sucker",
         "black bullhead",
         "brown bullhead",
         "yellow bullhead")%>%
  pivot_longer(cols = !c(SURVEY_ID, SURVEYDATE, SURVEYTYPE, DOW, LKNAME, YEAR, GEAR, EFFORT, WATERBODY_TYPE),
               names_to = "COMMON_NAME", values_to = "TOTAL_CATCH")%>%
  mutate(GEAR_CATEGORY = case_when(GEAR == "GN" ~"GN",
                                   GEAR == "GDE" ~ "GN",
                                   GEAR == "GSH" ~ "GN",
                                   GEAR == "TN" ~ "TN",
                                   GEAR == "EF" ~ "EF"))%>%
  mutate(CPUE = TOTAL_CATCH/EFFORT)%>%
  mutate(CPUE = round(CPUE, digits = 2)) #14 species times 21207 survey/gears = 296,898 rows 

#write_csv(MN_Catch_0, "MN_Fish_Data_21JUN2023.csv")




```


---
title: "b_WI_Flat_File_Aggregation"
author: "Holly Kundel & Mike Verhoeven"
date: "`r Sys.Date()`"
output: html_document
---
This is Holly's first attempt at aggregating WI data using the new workflow format

# Preamble

libraries
```{r}
library(arrow)
library(readr)
library(dplyr)
library(stringr)
library(data.table)
library(janitor)
library(tidyr)
library(lubridate)
library(ggplot2)

options(scipen = 999)
```


# Load Data

* First run CASC Data Explainer
* note Holly has to change "E" in file paths to "D" 
```{r}

files_list <- list.files(path = "D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/WI_Data/wi_raw_disaggregated_data", pattern = ".+\\.csv") #grabs only.csv files
files_list


n <- length(files_list)

for(i in 1:n) {
  #i = 3
  filei <- word(gsub(".csv","", files_list[i]), start = -1, sep = fixed("/"))
  #this does those two steps in one package
  assign(filei ,
          fread(paste0("D:/Shared drives/Hansen Lab/RESEARCH PROJECTS/Fish Survey Data/WI_Data/wi_raw_disaggregated_data/",
                                          files_list[i])))
  
  # note we want to review a sorted list of column names to check misspelling etc.
  # we still need to use the columns with names like col_name_length_in, or known_units
  
  
  cde %>% # call data explainer file
    filter(`new_file_name`== filei)%>% #keep only the row relevant to this file
    select_if(~ !any(is.na(.))) %>% 
    transpose(keep.names = "newname") %>% 
    rename("oldname" = V1) %>% 
    assign("names", ., envir = .GlobalEnv)
  
  #see if any column names will not have a match! 
  # IF any pop FALSE, force stop and revist of data explainer ()
  # - e.g., named something "total catch" when actual column name was "total_catch"
  print(
    cbind(colnames(get(filei)),
          colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ]
    )
  )
  
  #this line is where the warnings are coming from
  # break the loop if the current file has column names not in the data explainer
  if (all(cbind(colnames(get(filei)),  colnames(get(filei)) %in% names[ !str_detect(newname,"unique_row_key"), oldname, ])[,2]) == FALSE ) break
  
  # append old col names into new "notes" columns:
  get(filei)[ , (names[ str_detect(newname, "notes") , oldname   ,  ]) := Map(paste, colnames(.SD), .SD, sep = ':') , .SDcols =  names[ str_detect(newname, "notes") , oldname   ,  ] ]
  
  #now rename that file's colnames
  setnames(get(filei), colnames(get(filei)), names[!str_detect(newname,"unique_row_key")] [match(names(get(filei)),names[!str_detect(newname,"unique_row_key"),oldname]), newname] )
  
  #append all other data from data explainer
  unusedbits <- 
    data.table(
      matrix(
        rep(names[ !newname %in% colnames(get(filei)) , oldname , ],
            each = nrow(get(filei))
        ),
        nrow = nrow(get(filei)),
        dimnames = list(rep(NA,nrow(get(filei))),
                        names[ !newname %in% colnames(get(filei)) , newname , ])
        )
      )
  
  #add all not yet used columns from data explainer:
  get(filei)[ , (names[ !newname %in% colnames(get(filei)) , newname , ]) := unusedbits[] ]

  #remove tempfile "unusedbits"
  rm(unusedbits)
  
  #confirm import of files:  
  print(paste(filei ,"added to workspace" ))  
  
} 

# check warnings and see if we can make it go away
#print some kind of completion confirmation?

```

# Identify Which data types are in each file
[1] "wi_inland_cpue_19Mar2021.csv"                  ~ CPUE (Effort and Catch)                 
[2] "wi_inland_effort_19Mar2021.csv"                ~ True Effort (as distance, sample_time_notes.1, gear_data_notes.9)          
[3] "wi_inland_fishobservations_19Mar2021.csv"      ~ Individual Fish    
[4] "wi_inland_lenage_19Mar2021.csv"                ~ Individual Fish             
[5] "wi_winnebago_cpue_23Apr2021.csv"               ~ CPUE (just has CPUE and units for CPUE)            
[6] "wi_winnebago_fishobservations_23April2021.csv" ~ Individual Fish




# Effort Merge

```{r}
# Only one "True Effort" file (each row is a gear in a survey): 'wi_inland_effort_19Mar2021'

# Rest of the files with Effort also have catch (species in a gear with a survey)

# CPUE/Effort Files with Catch: "wi_inland_cpue_19Mar2021" 

# wi_winnebago_cpue_23Apr2021.csv ~ only has CPUE and CPUE units. No catch or effort
    # effort for all winnebago surveys is "5 min trawl"


#investigate the one true effort file we have

# gears present
wi_inland_effort_19Mar2021[ ,.N , sampling_method ]
  # 53 unique gears: electrofishing, nets, hook and line, traps, trawls, etc.

wi_inland_effort_19Mar2021[sampling_method=="seine" , ,  ][gear_data_notes.9 == "number.of.nets:NA"]

# where do actual efforts live for each type of gear
wi_inland_effort_19Mar2021[ ,.N , .(sampling_method, distance, sample_time_notes.1, gear_data_notes.9) ]
  # it appears any kind of shocking effort is in "sample_time_notes.1 and "distance"
  # net effort is in "gear_data_notes.9"

wi_inland_effort_19Mar2021[ ,.(sampling_method, distance, gear_data_notes.1, gear_data_notes.2, gear_data_notes.3, gear_data_notes.4, gear_data_notes.5, gear_data_notes.6, gear_data_notes.7, gear_data_notes.8, gear_data_notes.9, gear_data_notes.10, gear_data_notes.11, gear_data_notes.12, gear_data_notes.13, sample_time_notes.1, sample_time_notes.2) , sampling_method]

#is survey_id unique to each survey?
wi_inland_effort_19Mar2021[ , , survey_id]
    # yes!
wi_inland_effort_19Mar2021[ , , .(lake_id, date.1, sampling_method)]
  # lake_id, date.1, and sampling_method also work as a key

# gear_data_notes 1:8 and 12 through 15 are all electrofishing details
# gear_data_notes 10: depth


# Work on making an "effort" and "effort units" column
gear_table <- wi_inland_effort_19Mar2021[ ,.N , sampling_method ]

gear_table[str_detect(sampling_method, "shock") ,simple_gear:= "electrofishing",] 
gear_table[str_detect(sampling_method, "net"), simple_gear:= "netting"]
gear_table[str_detect(sampling_method, "hook"), simple_gear:= "hook and line"]
gear_table[str_detect(sampling_method, "seine"), simple_gear:= "seine"]
gear_table[str_detect(sampling_method, "weir"), simple_gear:= "weir"]
gear_table[str_detect(sampling_method, "trap"), simple_gear:= "trapping"]
gear_table[str_detect(sampling_method, "trawl"), simple_gear:= "trawling"]
gear_table[str_detect(sampling_method, "cage"), simple_gear:= "trapping"]
gear_table[sampling_method=="unknown", simple_gear:= "unknown"]
gear_table[sampling_method=="poison", simple_gear:= "other"]
gear_table[sampling_method=="setline", simple_gear:= "other"]
gear_table[sampling_method=="limbline", simple_gear:= "other"]
gear_table[sampling_method=="visual_observe", simple_gear:= "other"]
gear_table[sampling_method=="multiple_gear_types", simple_gear:= "other"]
gear_table[sampling_method=="bankpole", simple_gear:= "other"]
gear_table[sampling_method=="spearing", simple_gear:= "other"]
gear_table[sampling_method=="scuba_diving", simple_gear:= "other"]
gear_table[sampling_method=="grid", simple_gear:= "other"][]

gear_table[is.na(simple_gear), .N, ]
# all gears have been assigned a "simple gear"

#now add effort and effort units columns
#gear_table[simple_gear == "electrofishing", ':='( effort_col ="distance", effort_units_col = "distance_units")]
#gear_table[simple_gear == "netting", ':='( effort_col ="gear_data_notes.9", effort_units_col = "net_nights")][]


#join gear table back to original data
wi_inland_effort_19Mar2021[gear_table, on = "sampling_method", simple_gear:=simple_gear]
wi_inland_effort_19Mar2021[sampling_method == "fyke_net", , ]
wi_inland_effort_19Mar2021[simple_gear == "electrofishing", ':='( effort =distance, effort_units = distance_units)]
wi_inland_effort_19Mar2021[simple_gear == "netting", ':='( effort =gear_data_notes.9, effort_units = "net_nights")][]



### doing this with dplyr functions for now, can update to data.table later
    ### how do we want to name the effort columns so they match format from other files/states should we have sample.time 1 and 2 for minutes EF and hours nets are in or should we have total.effort.1 be distance and number of nets and total.effort.2 be minutes EF and hours nets are in..? both are important. Just need a naming scheme

# used code chunk below to check where effort lived for these gears
#wi_gear_eff_check <- wi_inland_effort_19Mar2021 %>%
#  select(gear_data_notes.11, sample_time_notes.1, sample_time_notes.3, gear_data_notes.9, sampling_method)%>%
#  filter(sampling_method %in% c("seine"))


# create effort column based upon which gear was used while retaining all original columns, not perfect, but pretty complete

wi_inland_effort <- wi_inland_effort_19Mar2021 %>%
  left_join(gear_table, by = "sampling_method")%>% #join gear table
  relocate(county, lake_name.1, lake_id, year, survey_id, sample_id.1, sampling_method, simple_gear, date.1, distance, distance_units, sample_time_notes.1, gear_data_notes.9, sample_time_notes.3)%>% #take these columns and put them in front
  mutate(sample_time_min = str_sub(sample_time_notes.1, 22))%>% #keep only the number of minutes
  mutate(hours_set_net = str_sub(sample_time_notes.3, 11)) %>% #keep only the number of hours nets are in
  mutate(number_of_nets = str_sub(gear_data_notes.9, 16))%>% #keep just number of nets
  mutate(distance = as.character(distance))%>% #make this a character so it can be used with other gear types
  mutate(total.effort.1 = case_when(simple_gear == "electrofishing" ~ sample_time_min, #create total effort 1
                                    simple_gear == "netting" ~ hours_set_net,
                                    simple_gear == "hook and line" ~ sample_time_min,
                                    simple_gear == "seine" ~ sample_time_min,
                                    simple_gear == "trapping" ~ hours_set_net,
                                    simple_gear == "trawling" ~ sample_time_min,
                                    simple_gear == "unknown" ~ NA,
                                    simple_gear == "weir" ~ NA,
                                    sampling_method == "poison" ~ NA,
                                    sampling_method == "limbline" ~ sample_time_min,
                                    sampling_method == "scuba_diving" ~ sample_time_min,
                                    sampling_method == "spearing" ~ hours_set_net,
                                    sampling_method == "visual_observe" ~ NA,
                                    sampling_method == "bankpole" ~ sample_time_min,
                                    sampling_method == "dip_net" ~ sample_time_min,
                                    sampling_method == "setline" ~ sample_time_min,
                                    simple_gear == "seine" ~ hours_set_net))%>%
  mutate(total.effort.2 = case_when(simple_gear == "electrofishing" ~ distance, #create total effort 2 if two relevant efforts
                                    simple_gear == "netting" ~ number_of_nets,
                                    simple_gear == "trapping" ~ number_of_nets,
                                    simple_gear == "seine" ~ number_of_nets))%>%
  mutate(total.effort.1.units = case_when(simple_gear == "electrofishing" ~ "minutes", #assign units to efforts in effort 1
                                    simple_gear == "netting" ~ "hours",
                                    simple_gear == "hook and line" ~ "minutes",
                                    simple_gear == "seine" ~ "minutes",
                                    simple_gear == "trapping" ~ "hours",
                                    simple_gear == "trawling" ~ "minutes",
                                    simple_gear == "unknown" ~ NA,
                                    simple_gear == "weir" ~ NA,
                                    sampling_method == "poison" ~ NA,
                                    sampling_method == "limbline" ~ "minutes",
                                    sampling_method == "scuba_diving" ~ "minutes",
                                    sampling_method == "spearing" ~ "hours",
                                    sampling_method == "visual_observe" ~ NA,
                                    sampling_method == "bankpole" ~ "minutes",
                                    sampling_method == "dip_net" ~ "minutes",
                                    sampling_method == "setline" ~ "minutes"))%>%
  mutate(total.effort.2.units = case_when(simple_gear == "electrofishing" ~ "miles", #assign units to efforts in effort 2
                                    simple_gear == "netting" ~ "number_of_nets",
                                    simple_gear == "trapping" ~ "number_of_traps",
                                    simple_gear == "seine" ~ "number_of_nets"))%>%
  select(county, lake_name.1, lake_id, year, survey_id, sampling_method, date.1, total.effort.1, total.effort.1.units, total.effort.2, total.effort.2.units)%>% #subset these columns to export for later, my r is having a hard time with it
  mutate(total.effort.1 = na_if(total.effort.1, "NA"))%>% #some of the NAs from the gear_data_notes:NA aren't true NAs, change to true NA
  mutate(total.effort.2 = na_if(total.effort.2, "NA"))%>% #make character NA into true NA
  mutate(total.effort.1.units = ifelse(is.na(total.effort.1), NA, total.effort.1.units))%>% #make character NA into true NA
  mutate(total.effort.2.units = ifelse(is.na(total.effort.2), NA, total.effort.2.units)) #make character NA into true NA
  
#export as a csv in case r crashes
#write_csv(wi_inland_effort, "wi_inland_effort_gear_table.csv")       
  
```

Find a unique key for these files
```{r}
# date format is "POSIXct" and it won't subset properly, so first change to IDate
wi_winnebago_cpue_23Apr2021[ , date.1 := as.IDate(date.1),]

#subset by date, see if multiple trawls are done per day per site
  # are the species aggregated? Or listed once per site?
wi_winnebago_cpue_23Apr2021[ date.1 == "1986-06-11", .N , .(site_id.1, site_id.2, site_id.3, site_id.4, species.1) ]
    # appears that there is one trawl per site (using all 4 IDs), species are listed once per site, so CPUE is total catch


# see if this holds true to the whole dataset
wi_winnebago_cpue_23Apr2021[ , .N , .(site_id.1, site_id.2, site_id.3, site_id.4, species.1, date.1) ]

# Are there any instances where N > 1
wi_winnebago_cpue_23Apr2021[ , .N , .(site_id.1, site_id.2, site_id.3, site_id.4, species.1, date.1) ] [N>1, , ]
    # YES, three instances where N > 1, what else can we add to get a unique key?

#Try adding mesh size (now named "gear_data_notes.1")
wi_winnebago_cpue_23Apr2021[ , .N , .(site_id.1, site_id.2, site_id.3, site_id.4, species.1, date.1, gear_data_notes.1) ] [N>1, , ]
    # that worked! THIS IS OUR UNIQUE KEY

#check that we have the same number of rows that we started with
wi_winnebago_cpue_23Apr2021[ , .N , .(site_id.1, site_id.2, site_id.3, site_id.4, species.1, date.1, gear_data_notes.1) ] [, , ]
      # yes we do

# are the units always "catch_per_5_min_trawl" ?
wi_winnebago_cpue_23Apr2021[ ,unique(cpue_units) , ]
    # yes! So effort is constant, always 5 minutes per trawl

# how often is included in the data?
wi_winnebago_cpue_23Apr2021[ ,.N, gear_data_notes.1 ]
    # hardly ever, mostly NA or 0. It is specified 4 times as an actual mesh size. 
```

Format wi_winnebago_cpue_23Apr2021 from just cpue file to a file with catch and effort listed
```{r}
# rename "cpue" column to 'total_count' to match format of other files
    # get all column names from this DT, select only the column named "cpue", rename it "total_count"

    # *note from "lake_winnebago_metadata_readme" : "-since the trawls are 5 minutes each the count values from winnebago_trawl_data.csv are simply summed to compute the cpe"
colnames(wi_winnebago_cpue_23Apr2021)[colnames(wi_winnebago_cpue_23Apr2021)=="cpue"] <- "total_count"


#add a column for effort
wi_winnebago_cpue_23Apr2021[ ,total_effort_1.1 := "5 minute trawl", ]

### would it be helpful to have it be # of fish per minute of trawl? Probably not because the trawls are always the same as is idk it's confusing in its current format
```


Make WI Inland CPUE file into a catch file
```{r}

```


#drop cpue
## create an issue for this idea
  #general gears
  mn_fish_effort_03May2022[ , cpue , ] #view CPUE
  mn_fish_effort_03May2022[ , round(total_count/total_effort_1.1,2) , ]
  sum(!mn_fish_effort_03May2022[ , cpue == round(total_count/total_effort_1.1,2) , ])# the number of cases where DNR calcd CPUE does not == catch/effort
  
  #this is odd, suggests something wonky w/ dnr measured cpues
  mn_fish_effort_03May2022[ , cpue := NULL ,]
  
  #deep and shallow Gns
  sum(!mn_gde_gsh_fish_effort_03May2022[ , cpue == round(total_count/total_effort_1.1,2) , ])# the number of cases where DNR calcd CPUE does not == catch/effort
  ## create an issue for this idea
  #this is odd, suggests something wonky w/ dnr measured cpues
  mn_gde_gsh_fish_effort_03May2022[ , cpue := NULL ,]

  #tag the species for easy col selection:
  mn_gde_gsh_fish_effort_03May2022[ , species.1 := paste("taxa", species.1, sep = "_")]
  mn_fish_effort_03May2022[ , species.1 := paste("taxa", species.1, sep = "_")]

# species, total count and cpue are only species specific components (cpue has been dropped)
mn_fish_effort_03May2022 <- dcast(mn_fish_effort_03May2022 , ... ~ species.1 , value.var = "total_count", fill = 0)
mn_gde_gsh_fish_effort_03May2022 <- dcast(mn_gde_gsh_fish_effort_03May2022 , ... ~ species.1 , value.var = "total_count", fill = 0)


# this rbind puts together 3 files that should now be equivalent (each row is gear in a survey)
effort <- rbindlist(list(rbindlist(list(mn_gde_gsh_fish_effort_03May2022,
                                    mn_fish_effort_03May2022),
                               fill = TRUE,
                               use.names = TRUE),
                     mn_ef_lmb_smb_effort_26Aug2022),
                fill = TRUE,
                use.names = TRUE)



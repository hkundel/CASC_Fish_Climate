---
title: "c_MN_Filtering_for_CPUE"
author: "Denver Link"
date: "2023-10-28"
output: html_document
editor_options: 
  chunk_output_type: console
---

#need to get water temp in to filter for min water temp
#na values for cpue

#Library
```{r}
library(tidyverse)
library(arrow)
```

#data
```{r}
filter_table <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(state == "Minnesota")

mn_data <- open_dataset(sources = file.path("D:", "Shared drives", "Hansen Lab", "RESEARCH PROJECTS", "Fish Survey Data", "Parquet files", "mn_file_arrow"))

mn_data %>% 
  group_by(sampling_method) %>% 
  count() %>% 
  collect() %>% 
  print(n = nrow(.))
```

#walleye filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

------------everything below has not been edited 11/1--------------------------

#black crappie filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#bluegill filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#largemouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#smallmouth filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#cisco filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#northern pike filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#yellow perch filtering
```{r}
#filters for metric (adult abundance) and selects columns needed for survey filtering
filter_table_effort <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  select(-metric,
         -species_1,
         -month_min,
         -month_max,
         -water_temp_min,
         -water_temp_max)

#selects fish level filters to be applied in the second filtering step
filter_table_fish <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSkGZinLPrSuv1DorBrAkV2JNUZsOlpG7jk_WsnGyZX56z9JMVcGHdCPlsxInjOdjUH0tXb4nBwt9Js/pub?output=csv") %>% 
  filter(metric == "adult_abundance" & state == "Minnesota" & species_1 == "walleye") %>% 
  rename(survey_type.1 = survey_type) %>% 
  #fish level parameters of interest 
  select(state) %>% 
  distinct() 

good_surveys <- mn_data %>% 
  right_join(filter_table_effort, by = c("state",
                                        "survey_type.1",
                                        "sampling_method",
                                        "area_group")) %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  filter(total_effort_1.1 >= effort_min) %>% 
  collect()

#checking filtering
#month range
good_surveys %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#sampling method
good_surveys %>% 
  group_by(sampling_method) %>% 
  count()

#survey purpose
good_surveys %>% 
  group_by(survey_type.1) %>% 
  count()

#do I have all area groupings?
good_surveys %>% 
  group_by(area_group) %>% 
  count()

#min effort by grouping
good_surveys %>% 
  group_by(area_group) %>% 
  summarise(min_effort = min(total_effort_1.1))

#345 lakes with na nhdids
good_surveys %>% 
  filter(is.na(nhdhr.id))

adult_walleye <- mn_data %>% 
  #filter the Wisconsin data set for surveys that were good for species abundance
  right_join(good_surveys) %>% 
  #filter for fish level items (length, etc)
  right_join(filter_table_fish) %>% 
  #do not include na nothing caught
  collect() 
glimpse(adult_walleye)

#checking final filter
adult_walleye %>% 
  group_by(species.1) %>% 
  count()

#is the state label the same for all fish
adult_walleye %>% 
  group_by(state) %>% 
  count()

#is each sampling method correct for the filter?
adult_walleye %>% 
  group_by(sampling_method) %>% 
  summarise(min.month = min(month(date_clean)), max.month = max(month(date_clean)))

#do I retain all of the good surveys? - rows here should match good surveys 
adult_walleye %>% 
  distinct(lake_id,
           nhdhr.id,
           date_clean,
           survey_type.1,
           sampling_method,
           total_effort_1.1,
           effort_units.1,
           area_group,
           effort_min) %>% 
  group_by(sampling_method) %>% 
  glimpse()
#i do not retain surveys with na nhdids

#creating cpue for adult walleye 
adult_walleye_cpue <- adult_walleye %>% 
  group_by(lake_id,
           nhdhr.id,
           date_clean,
           sampling_method,
           total_effort_1.1,
           effort_units.1) %>% 
  summarise(count_walleye = sum(species.1 == 'walleye')) %>%
  mutate(cpue = count_walleye/as.numeric(total_effort_1.1)) %>% 
  filter(!is.na(cpue)) %>% 
  collect()
```

#combining species
```{r}
mn_filtered_species <- bind_rows(adult_walleye_cpue, 
                                 adult_bluegill_cpue, 
                                 adult_largemouth_cpue, 
                                 adult_smallmouth_cpue, 
                                 adult_cisco_cpue, 
                                 adult_pike_cpue, 
                                 adult_perch_cpue)
```